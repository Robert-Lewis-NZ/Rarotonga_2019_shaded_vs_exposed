#   ungroup() %>%
#  summarise(sum(niche == "Cryptic_only"), sum(niche == "Exposed_only"), sum(niche == "Both"))
ASV_order <- differential_ASV %>%
ungroup() %>%
select(OTU, species) %>%
select(OTU) %>%
distinct() %>%
as.list
Deseq2_pal <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
names(Deseq2_pal) <- c("Acropora cf anthocercis", "Acropora elseyi", "Acropora hyacinthus", "Hydnophora microconos", "Porites lutea cf. lobata", "Acropora nasuta", "Favia stelligera")
differential_ASV %>%
ungroup() %>%
mutate(OTU = fct_relevel(OTU, ASV_order)) %>%
mutate(Direction = if_else(log2FoldChange > 0, "exposed", "cryptic")) %>%
ggplot(aes(x = OTU, y = log2FoldChange, shape = Direction, fill = species)) +
geom_point(size = 3) +
guides(shape = guide_legend(order=1)) +
scale_shape_manual(values = c(exposed = 22, cryptic = 21), labels = c("Exposed", "Shaded")) +
scale_fill_manual(values = Deseq2_pal,
name = "Species",
guide = guide_legend(override.aes = aes(shape=21),
label.theme = element_text(size = 10, face = "italic"))) +
geom_abline(intercept = 0, slope = 0, linetype = 3) +
theme_bw() +
theme(panel.border = element_rect(colour = "black", fill=NA), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
theme(axis.text.x = element_blank(), axis.ticks.x=element_blank()) +
#facet_wrap(~species, scales = "free_x", ncol = 2) +
xlab("ASV") +
ylab("Log2 fold change") +
theme(strip.text = element_text(face = "italic")) +
theme(legend.box = "vertical", legend.text = element_text(size = 10))
ggsave("Fig_differential_abundance.pdf", units = "in", width = 7, height = 5)
differential_ASV %>%
ungroup() %>%
mutate(OTU = fct_relevel(OTU, ASV_order)) %>%
mutate(Direction = if_else(log2FoldChange > 0, "exposed", "cryptic")) %>%
ggplot(aes(x = OTU, y = log2FoldChange, shape = Direction, fill = species)) +
geom_point(size = 3) +
guides(shape = guide_legend(order=1)) +
scale_shape_manual(values = c(exposed = 22, cryptic = 21), labels = c("Exposed", "Shaded")) +
scale_fill_manual(values = Deseq2_pal,
name = "Species",
guide = guide_legend(override.aes = aes(shape=21),
label.theme = element_text(size = 10, face = "italic"))) +
geom_abline(intercept = 0, slope = 0, linetype = 3) +
theme_bw() +
theme(panel.border = element_rect(colour = "black", fill=NA), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
theme(axis.text.x = element_blank()) +
#facet_wrap(~species, scales = "free_x", ncol = 2) +
xlab("ASV") +
ylab("Log2 fold change") +
theme(strip.text = element_text(face = "italic")) +
theme(legend.box = "vertical", legend.text = element_text(size = 10))
differential_MED %>%
group_by(species) %>%
summarise(sum_seq = n_distinct(seq))
differential_abundance_freq <- differential_MED %>%
group_by(species) %>%
summarise(sum_dif_abundant = sum(Abundance))
post_MED_abs_total <- post_MED_abs %>%
filter(project == "c_v_e") %>%
dplyr::rename(seq = seq_name) %>%
filter(Abundance > 0) %>%
select(seq, Abundance, species, habitat) %>%
group_by(species) %>%
summarise(total_Abundance = sum(Abundance))
differential_abundance_freq <- left_join(differential_abundance_freq, post_MED_abs_total, by = "species")
differential_abundance_freq %>%
mutate(freq = sum_dif_abundant/total_Abundance) %>%
summarise(mean_rel_freq = mean(freq), sd = sd(freq))
MED_order <- differential_MED %>%
ungroup() %>%
select(seq, species) %>%
select(seq) %>%
distinct() %>%
as.list
Deseq2_pal <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999")
names(Deseq2_pal) <- c("Acropora cf anthocercis", "Acropora elseyi", "Acropora hyacinthus", "Hydnophora microconos", "Porites lutea cf. lobata", "Acropora nasuta", "Favia stelligera", "Leptoria phrygia")
differential_MED %>%
ungroup() %>%
rename(Species = species) %>%
mutate(seq = fct_relevel(seq, MED_order)) %>%
mutate(Direction = if_else(log2FoldChange > 0, "exposed", "cryptic")) %>%
ggplot(aes(x = seq, y = log2FoldChange, shape = Direction, fill = Species)) +
geom_point(size = 3) +
guides(shape = guide_legend(order=1)) +
scale_shape_manual(values = c(exposed = 22, cryptic = 21), labels = c("Exposed", "Shaded")) +
scale_fill_manual(values = Deseq2_pal,
guide = guide_legend(override.aes = aes(shape=21), label.theme = element_text(size = 10, face = "italic"))) +
geom_abline(intercept = 0, slope = 0, linetype = 3) +
theme_bw() +
theme(panel.border = element_rect(colour = "black", fill=NA), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
theme(axis.text.x = element_blank()) +
xlab("Post-MED sequence") +
ylab("Log2 fold change") +
theme(strip.text = element_text(face = "italic")) +
scale_x_discrete(breaks=1:10)
ggsave("Fig_differential_abundance_MED.pdf", units = "in", width = 7, height = 5)
differential_MED %>%
ungroup() %>%
rename(Species = species) %>%
mutate(seq = fct_relevel(seq, MED_order)) %>%
mutate(Direction = if_else(log2FoldChange > 0, "exposed", "cryptic")) %>%
ggplot(aes(x = seq, y = log2FoldChange, shape = Direction, fill = Species)) +
geom_point(size = 3) +
guides(shape = guide_legend(order=1)) +
scale_shape_manual(values = c(exposed = 22, cryptic = 21), labels = c("Exposed", "Shaded")) +
scale_fill_manual(values = Deseq2_pal,
guide = guide_legend(override.aes = aes(shape=21), label.theme = element_text(size = 10, face = "italic"))) +
geom_abline(intercept = 0, slope = 0, linetype = 3) +
theme_bw() +
theme(panel.border = element_rect(colour = "black", fill=NA), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
theme(axis.text.x = element_blank()) +
xlab("Post-MED sequence") +
ylab("Log2 fold change") +
theme(strip.text = element_text(face = "italic")) +
scale_x_discrete(breaks=1:10)
differential_MED %>%
ungroup() %>%
rename(Species = species) %>%
mutate(seq = fct_relevel(seq, MED_order)) %>%
mutate(Direction = if_else(log2FoldChange > 0, "exposed", "cryptic")) %>%
ggplot(aes(x = seq, y = log2FoldChange, shape = Direction, fill = Species)) +
geom_point(size = 3) +
guides(shape = guide_legend(order=1)) +
scale_shape_manual(values = c(exposed = 22, cryptic = 21), labels = c("Exposed", "Shaded")) +
scale_fill_manual(values = Deseq2_pal,
guide = guide_legend(override.aes = aes(shape=21), label.theme = element_text(size = 10, face = "italic"))) +
geom_abline(intercept = 0, slope = 0, linetype = 3) +
theme_bw() +
theme(panel.border = element_rect(colour = "black", fill=NA), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.x = element_blank()) +
xlab("Post-MED sequence") +
ylab("Log2 fold change") +
theme(strip.text = element_text(face = "italic")) +
scale_x_discrete(breaks=1:10)
differential_MED %>%
ungroup() %>%
rename(Species = species) %>%
mutate(seq = fct_relevel(seq, MED_order)) %>%
mutate(Direction = if_else(log2FoldChange > 0, "exposed", "cryptic")) %>%
ggplot(aes(x = seq, y = log2FoldChange, shape = Direction, fill = Species)) +
geom_point(size = 3) +
guides(shape = guide_legend(order=1)) +
scale_shape_manual(values = c(exposed = 22, cryptic = 21), labels = c("Exposed", "Shaded")) +
scale_fill_manual(values = Deseq2_pal,
guide = guide_legend(override.aes = aes(shape=21), label.theme = element_text(size = 10, face = "italic"))) +
geom_abline(intercept = 0, slope = 0, linetype = 3) +
theme_bw() +
theme(panel.border = element_rect(colour = "black", fill=NA), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.x = element_blank(), axis.ticks.x = TRUE) +
xlab("Post-MED sequence") +
ylab("Log2 fold change") +
theme(strip.text = element_text(face = "italic")) +
scale_x_discrete(breaks=1:10)
differential_MED %>%
ungroup() %>%
rename(Species = species) %>%
mutate(seq = fct_relevel(seq, MED_order)) %>%
mutate(Direction = if_else(log2FoldChange > 0, "exposed", "cryptic")) %>%
ggplot(aes(x = seq, y = log2FoldChange, shape = Direction, fill = Species)) +
geom_point(size = 3) +
guides(shape = guide_legend(order=1)) +
scale_shape_manual(values = c(exposed = 22, cryptic = 21), labels = c("Exposed", "Shaded")) +
scale_fill_manual(values = Deseq2_pal,
guide = guide_legend(override.aes = aes(shape=21), label.theme = element_text(size = 10, face = "italic"))) +
geom_abline(intercept = 0, slope = 0, linetype = 3) +
theme_bw() +
theme(panel.border = element_rect(colour = "black", fill=NA), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.x = element_blank(), axis.ticks.x = element_line()) +
xlab("Post-MED sequence") +
ylab("Log2 fold change") +
theme(strip.text = element_text(face = "italic")) +
scale_x_discrete(breaks=1:10)
differential_MED %>%
ungroup() %>%
rename(Species = species) %>%
mutate(seq = fct_relevel(seq, MED_order)) %>%
mutate(Direction = if_else(log2FoldChange > 0, "exposed", "cryptic")) %>%
ggplot(aes(x = seq, y = log2FoldChange, shape = Direction, fill = Species)) +
geom_point(size = 3) +
guides(shape = guide_legend(order=1)) +
scale_shape_manual(values = c(exposed = 22, cryptic = 21), labels = c("Exposed", "Shaded")) +
scale_fill_manual(values = Deseq2_pal,
guide = guide_legend(override.aes = aes(shape=21), label.theme = element_text(size = 10, face = "italic"))) +
geom_abline(intercept = 0, slope = 0, linetype = 3) +
theme_bw() +
theme(panel.border = element_rect(colour = "black", fill=NA), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.x = element_blank(), axis.ticks.x = element_line()) +
xlab("Post-MED sequence") +
ylab("Log2 fold change") +
theme(strip.text = element_text(face = "italic"))
differential_MED %>%
ungroup() %>%
rename(Species = species) %>%
mutate(seq = fct_relevel(seq, MED_order)) %>%
mutate(Direction = if_else(log2FoldChange > 0, "exposed", "cryptic")) %>%
ggplot(aes(x = seq, y = log2FoldChange, shape = Direction, fill = Species)) +
geom_point(size = 3) +
guides(shape = guide_legend(order=1)) +
scale_shape_manual(values = c(exposed = 22, cryptic = 21), labels = c("Exposed", "Shaded")) +
scale_fill_manual(values = Deseq2_pal,
guide = guide_legend(override.aes = aes(shape=21), label.theme = element_text(size = 10, face = "italic"))) +
geom_abline(intercept = 0, slope = 0, linetype = 3) +
theme_bw() +
theme(panel.border = element_rect(colour = "black", fill=NA), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.x = element_blank()) +
xlab("Post-MED sequence") +
ylab("Log2 fold change") +
theme(strip.text = element_text(face = "italic"))
ggsave("Fig_differential_abundance_MED.pdf", units = "in", width = 7, height = 5)
Deseq2_pal <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
names(Deseq2_pal) <- c("Acropora cf anthocercis", "Acropora elseyi", "Acropora hyacinthus", "Hydnophora microconos", "Porites lutea cf. lobata", "Acropora nasuta", "Favia stelligera")
differential_MED %>%
ungroup() %>%
rename(Species = species) %>%
mutate(seq = fct_relevel(seq, MED_order)) %>%
mutate(Direction = if_else(log2FoldChange > 0, "exposed", "cryptic")) %>%
ggplot(aes(x = seq, y = log2FoldChange, shape = Direction, fill = Species)) +
geom_point(size = 3) +
guides(shape = guide_legend(order=1)) +
scale_shape_manual(values = c(exposed = 22, cryptic = 21), labels = c("Exposed", "Shaded")) +
scale_fill_manual(values = Deseq2_pal,
guide = guide_legend(override.aes = aes(shape=21), label.theme = element_text(size = 10, face = "italic"))) +
geom_abline(intercept = 0, slope = 0, linetype = 3) +
theme_bw() +
theme(panel.border = element_rect(colour = "black", fill=NA), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.x = element_blank()) +
xlab("Post-MED sequence") +
ylab("Log2 fold change") +
theme(strip.text = element_text(face = "italic"))
ggsave("Fig_differential_abundance_MED.pdf", units = "in", width = 7, height = 5)
differential_MED %>%
ungroup() %>%
rename(Species = species) %>%
mutate(seq = fct_relevel(seq, MED_order)) %>%
mutate(Direction = if_else(log2FoldChange > 0, "exposed", "cryptic")) %>%
ggplot(aes(x = seq, y = log2FoldChange, shape = Direction, fill = Species)) +
geom_point(size = 3) +
guides(shape = guide_legend(order=1)) +
scale_shape_manual(values = c(exposed = 22, cryptic = 21), labels = c("Exposed", "Shaded")) +
scale_fill_manual(values = Deseq2_pal,
guide = guide_legend(override.aes = aes(shape=21), label.theme = element_text(size = 10, face = "italic"))) +
geom_abline(intercept = 0, slope = 0, linetype = 3) +
theme_bw() +
theme(panel.border = element_rect(colour = "black", fill=NA), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.x = element_blank()) +
xlab("Post-MED sequence") +
ylab("Log2 fold change") +
theme(strip.text = element_text(face = "italic"))
differential_ASV %>%
ungroup() %>%
mutate(OTU = fct_relevel(OTU, ASV_order)) %>%
mutate(Direction = if_else(log2FoldChange > 0, "exposed", "cryptic")) %>%
ggplot(aes(x = OTU, y = log2FoldChange, shape = Direction, fill = species)) +
geom_point(size = 3) +
guides(shape = guide_legend(order=1)) +
scale_shape_manual(values = c(exposed = 22, cryptic = 21), labels = c("Exposed", "Shaded")) +
scale_fill_manual(values = Deseq2_pal,
name = "Species",
guide = guide_legend(override.aes = aes(shape=21),
label.theme = element_text(size = 10, face = "italic"))) +
geom_abline(intercept = 0, slope = 0, linetype = 3) +
theme_bw() +
theme(panel.border = element_rect(colour = "black", fill=NA), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
theme(axis.text.x = element_blank()) +
#facet_wrap(~species, scales = "free_x", ncol = 2) +
xlab("ASV") +
ylab("Log2 fold change") +
theme(strip.text = element_text(face = "italic")) +
theme(legend.box = "vertical", legend.text = element_text(size = 10))
ggsave("Fig_differential_abundance.pdf", units = "in", width = 7, height = 5)
library(tidyverse)
library(dada2)
library(ShortRead)
library(Biostrings)
library(phyloseq)
library(DECIPHER)
library(msa)
library(phangorn)
library(seqinr)
library(ape)
library(treemapify)
library(kmer)
library(microbiome)
library(ggpubr)
library(vegan)
library(ggraph)
library(igraph)
library(tidygraph)
library(DESeq2)
library(tidytext)
library(reshape2)
library(bestNormalize)
library(ggrepel)
library(patchwork)
library(car)
library(ggalt)
library(ggVennDiagram)
source("help.R")
ps <- readRDS("ps.RDS")
melt <- readRDS("melt.RDS")
melt_4_deseq2 <- readRDS("melt_4_deseq2.RDS")
ps_sub <- readRDS("ps_sub_w_kmer_tree.rds")
dynamQ_max_EnormEk <- readRDS("dynamQ_max_EnormEk.rds")
FqFmparams <- readRDS("FqFmparams_no_PAR_adjust.rds")
total_brightness <- readRDS("total_brightness.rds")
raro_metadata <- read.csv("metadata_complete.csv")
NMDS_df <- readRDS("NMDS_df.RDS")
envfit_res <- readRDS("envfit_res.RDS")
scores <- readRDS("scores.RDS")
ps_rare <- readRDS("ps_rare_w_kmer_tree.rds")
pair_wise_photo <- readRDS("pair_wise_photo.RDS")
post_MED_abs <- readRDS("post_MED_abs.RDS")
differential_ASV <- readRDS("differential_ASV.rds")
differential_MED <- readRDS("differential_MED.rds")
View(ps_sub)
View(ps_rare)
View(ps)
View(ps_rare)
View(ps)
View(ps_rare)
#filter for only species with significantly differentially abundant sequnece variants
ps_hetero_ITS2 <- ps_sub %>%
subset_species(species == "Acropora cf anthocercis" | species == "Acropora elseyi" | species == "Acropora hyacinthus" | species == "Hydnophora microconos" | species == "Porites lutea cf. lobata" | species == "Acropora nasuta" | speces == "Favia stelligera")
#filter for only species with significantly differentially abundant sequnece variants
ps_hetero_ITS2 <- ps_sub %>%
subset_taxa(species == "Acropora cf anthocercis" | species == "Acropora elseyi" | species == "Acropora hyacinthus" | species == "Hydnophora microconos" | species == "Porites lutea cf. lobata" | species == "Acropora nasuta" | speces == "Favia stelligera")
melt <- psmelt(ps) %>%
mutate(Species = as.character(Species)) %>%
mutate(Species = case_when(str_detect(Species, "|") ~ word(as.character(Species), 1, sep = "\\|"),
TRUE ~ Species)) %>%
mutate(Species = as.factor(Species)) %>%
filter(Family == "Symbiodiniaceae", project == "c_v_e", Abundance > 0)
View(melt)
#filter for only species with significantly differentially abundant sequnece variants
ps_hetero_ITS2 <- ps_sub %>%
subset_taxa(species == "Acropora cf anthocercis" | species == "Acropora elseyi" | species == "Acropora hyacinthus" | species == "Hydnophora microconos" | species == "Porites lutea cf. lobata" | species == "Acropora nasuta" | speces == "Favia stelligera")
#filter for only species with significantly differentially abundant sequnece variants
ps_hetero_ITS2 <- ps_sub %>%
subset_taxa(species == "Acropora cf. anthocercis" | species == "Acropora elseyi" | species == "Acropora hyacinthus" | species == "Hydnophora microconos" | species == "Porites lutea cf. lobata" | species == "Acropora nasuta" | speces == "Favia stelligera")
#filter for only species with significantly differentially abundant sequnece variants
ps_hetero_ITS2 <- ps_sub %>%
subset_samples(species == "Acropora cf anthocercis" | species == "Acropora elseyi" | species == "Acropora hyacinthus" | species == "Hydnophora microconos" | species == "Porites lutea cf. lobata" | species == "Acropora nasuta" | speces == "Favia stelligera")
#filter for only species with significantly differentially abundant sequnece variants
ps_hetero_ITS2 <- ps_sub %>%
subset_samples(species == "Acropora cf anthocercis" | species == "Acropora elseyi" | species == "Acropora hyacinthus" | species == "Hydnophora microconos" | species == "Porites lutea cf. lobata" | species == "Acropora nasuta" | species == "Favia stelligera")
View(ps_hetero_ITS2)
View(ps_sub)
View(ps_hetero_ITS2)
#filter for only species with significantly differentially abundant sequnece variants
ps_hetero_ITS2 <- ps_sub %>%
subset_samples(species == "Acropora cf anthocercis" | species == "Acropora elseyi" | species == "Acropora hyacinthus" | species == "Hydnophora microconos" | species == "Porites lutea cf. lobata" | species == "Acropora nasuta" | species == "Favia stelligera")
# Transform abundances
ps.hell <- microbiome::transform(ps_hetero_ITS2, transform = "hellinger", target = "OTU", shift = 1, scale = 1)
#Create distance matrix
ps.uni_c_v_e <- phyloseq::distance(ps.hell, method = "wunifrac") %>% as.matrix()
long_dist <- reshape2::melt(ps.uni_c_v_e)[melt(lower.tri(ps.uni_c_v_e))$value,] %>%
#mutate(value = (1-value)*100) %>%
select(from = Var1, to = Var2, uni = value) %>%
mutate(pair1 = str_sub(from, start = 2),
pair2 = str_sub(to, start = 2)) %>%
filter(pair1 == pair2) %>%
mutate(pair1 = as.numeric(pair1), pair2 = as.numeric(pair2))
# Get photobiology
pair_wise_total_brightness <- left_join((total_brightness %>% rename(Sample = sampleID)), (melt %>% select(Sample, pair) %>% distinct()), by = "Sample") %>%
filter(Sample != "C49" & Sample != "E49" & Sample != "C96" & Sample != "E96") %>%
filter(species == "Acropora cf anthocercis" | species == "Acropora elseyi" | species == "Acropora hyacinthus" | species == "Hydnophora microconos" | species == "Porites lutea cf. lobata" | species == "Acropora nasuta" | species == "Favia stelligera") %>%
select(total_reflectance, pair, habitat) %>% pivot_wider(values_from = total_reflectance, names_from = habitat) %>%
rename(total_reflectance_cryptic = cryptic, total_reflectance_exposed = exposed)
pair_wise_photo <- pair_wise_photo %>%
mutate(pair = as.numeric(pair)) %>%
filter(pair != 96 & pair != 49)
pair_wise_photo <- left_join(pair_wise_photo, pair_wise_total_brightness, by = "pair")
long_dist_photo <- left_join(long_dist, pair_wise_photo, by = c("pair1" = "pair")) %>%
mutate(delta_onemQ = onemQ_cryptic - onemQ_exposed,
delta_onemC = onemC_exposed - onemC_cryptic,
delta_total_reflectance = total_reflectance_exposed - total_reflectance_cryptic)
ggplot(long_dist_photo, aes(uni, delta_onemQ)) +
geom_point(aes(col = species)) +
geom_encircle(aes(fill = species), s_shape = 1, expand = 0, alpha = 0.2, show.legend = FALSE) +
facet_wrap(~species)
ggplot(long_dist_photo, aes(uni, delta_onemC)) +
geom_point(aes(col = species)) +
geom_encircle(aes(fill = species), s_shape = 1, expand = 0, alpha = 0.2, show.legend = FALSE) +
facet_wrap(~species)
ggplot(long_dist_photo, aes(uni, delta_total_reflectance)) +
geom_point(aes(col = species)) +
geom_encircle(aes(fill = species), s_shape = 1, expand = 0, alpha = 0.2, show.legend = FALSE) +
facet_wrap(~species)
pair_wise_photo_Ek_FqFmmax <- FqFmparams %>%
ungroup() %>%
mutate(pair = str_sub(sampleID, start = 2)) %>%
select(pair, species, term, estimate, habitat) %>%
pivot_wider(names_from = term, values_from = estimate) %>%
pivot_wider(names_from = habitat, values_from = FqFmmax:Ek) %>%
mutate(pair = as.numeric(pair)) %>%
filter(pair != 96 & pair != 49)
saveRDS(pair_wise_photo_Ek_FqFmmax, "pair_wise_photo_Ek_FqFmmax.RDS")
long_dist_photo_Ek_FqFmmax <- left_join(long_dist, pair_wise_photo_Ek_FqFmmax, by = c("pair1" = "pair") ) %>%
mutate(delta_FqFmmax = FqFmmax_cryptic - FqFmmax_exposed,
delta_Ek = Ek_exposed - Ek_cryptic)
ggplot(long_dist_photo_Ek_FqFmmax, aes(uni, delta_Ek)) +
geom_point(aes(col = species)) +
geom_encircle(aes(fill = species), s_shape = 1, expand = 0, alpha = 0.2, show.legend = FALSE) +
facet_wrap(~species)
View(long_dist_photo_Ek_FqFmmax)
View(long_dist_photo)
#filter for only species with significantly differentially abundant sequnece variants
ps_hetero_ITS2 <- ps_sub %>%
subset_samples(species == "Acropora cf anthocercis" | species == "Acropora elseyi" | species == "Acropora hyacinthus" | species == "Hydnophora microconos" | species == "Porites lutea cf. lobata" | species == "Acropora nasuta" | species == "Favia stelligera")
# Transform abundances
ps.hell <- microbiome::transform(ps_hetero_ITS2, transform = "hellinger", target = "OTU", shift = 1, scale = 1)
#Create distance matrix
ps.uni_c_v_e <- phyloseq::distance(ps.hell, method = "wunifrac") %>% as.matrix()
long_dist <- reshape2::melt(ps.uni_c_v_e)[melt(lower.tri(ps.uni_c_v_e))$value,] %>%
#mutate(value = (1-value)*100) %>%
select(from = Var1, to = Var2, uni = value) %>%
mutate(pair1 = str_sub(from, start = 2),
pair2 = str_sub(to, start = 2)) %>%
filter(pair1 == pair2) %>%
mutate(pair1 = as.numeric(pair1), pair2 = as.numeric(pair2))
# Get photobiology
pair_wise_total_brightness <- left_join((total_brightness %>% rename(Sample = sampleID)), (melt %>% select(Sample, pair) %>% distinct()), by = "Sample") %>%
filter(Sample != "C49" & Sample != "E49" & Sample != "C96" & Sample != "E96") %>%
filter(species == "Acropora cf anthocercis" | species == "Acropora elseyi" | species == "Acropora hyacinthus" | species == "Hydnophora microconos" | species == "Porites lutea cf. lobata" | species == "Acropora nasuta" | species == "Favia stelligera") %>%
select(total_reflectance, pair, habitat) %>% pivot_wider(values_from = total_reflectance, names_from = habitat) %>%
rename(total_reflectance_cryptic = cryptic, total_reflectance_exposed = exposed)
pair_wise_photo <- pair_wise_photo %>%
mutate(pair = as.numeric(pair)) %>%
filter(pair != 96 & pair != 49)
pair_wise_photo <- left_join(pair_wise_photo, pair_wise_total_brightness, by = "pair")
long_dist_photo <- left_join(long_dist, pair_wise_photo, by = c("pair1" = "pair")) %>%
mutate(delta_onemQ = onemQ_cryptic - onemQ_exposed,
delta_onemC = onemC_exposed - onemC_cryptic,
delta_total_reflectance = total_reflectance_exposed - total_reflectance_cryptic)
long_dist_photo <- left_join(long_dist, pair_wise_photo, by = c("pair1" = "pair"))
View(pair_wise_photo)
#filter for only species with significantly differentially abundant sequnece variants
ps_hetero_ITS2 <- ps_sub %>%
subset_samples(species == "Acropora cf anthocercis" | species == "Acropora elseyi" | species == "Acropora hyacinthus" | species == "Hydnophora microconos" | species == "Porites lutea cf. lobata" | species == "Acropora nasuta" | species == "Favia stelligera")
ps.hell <- microbiome::transform(ps_hetero_ITS2, transform = "hellinger", target = "OTU", shift = 1, scale = 1)
#Create distance matrix
ps.uni_c_v_e <- phyloseq::distance(ps.hell, method = "wunifrac") %>% as.matrix()
#Create distance matrix
ps.uni_c_v_e <- phyloseq::distance(ps.hell, method = "wunifrac") %>% as.matrix()
long_dist <- reshape2::melt(ps.uni_c_v_e)[melt(lower.tri(ps.uni_c_v_e))$value,] %>%
#mutate(value = (1-value)*100) %>%
select(from = Var1, to = Var2, uni = value) %>%
mutate(pair1 = str_sub(from, start = 2),
pair2 = str_sub(to, start = 2)) %>%
filter(pair1 == pair2) %>%
mutate(pair1 = as.numeric(pair1), pair2 = as.numeric(pair2))
pair_wise_total_brightness <- left_join((total_brightness %>% rename(Sample = sampleID)), (melt %>% select(Sample, pair) %>% distinct()), by = "Sample") %>%
filter(Sample != "C49" & Sample != "E49" & Sample != "C96" & Sample != "E96") %>%
filter(species == "Acropora cf anthocercis" | species == "Acropora elseyi" | species == "Acropora hyacinthus" | species == "Hydnophora microconos" | species == "Porites lutea cf. lobata" | species == "Acropora nasuta" | species == "Favia stelligera") %>%
select(total_reflectance, pair, habitat) %>% pivot_wider(values_from = total_reflectance, names_from = habitat) %>%
rename(total_reflectance_cryptic = cryptic, total_reflectance_exposed = exposed)
pair_wise_photo <- pair_wise_photo %>%
mutate(pair = as.numeric(pair)) %>%
filter(pair != 96 & pair != 49) %>%
filter(species == "Acropora cf anthocercis" | species == "Acropora elseyi" | species == "Acropora hyacinthus" | species == "Hydnophora microconos" | species == "Porites lutea cf. lobata" | species == "Acropora nasuta" | species == "Favia stelligera")
pair_wise_photo <- left_join(pair_wise_photo, pair_wise_total_brightness, by = "pair")
long_dist_photo <- left_join(long_dist, pair_wise_photo, by = c("pair1" = "pair")) %>%
mutate(delta_onemQ = onemQ_cryptic - onemQ_exposed,
delta_onemC = onemC_exposed - onemC_cryptic,
delta_total_reflectance = total_reflectance_exposed - total_reflectance_cryptic)
ggplot(long_dist_photo, aes(uni, delta_onemQ)) +
geom_point(aes(col = species)) +
geom_encircle(aes(fill = species), s_shape = 1, expand = 0, alpha = 0.2, show.legend = FALSE) +
facet_wrap(~species)
ggplot(long_dist_photo, aes(uni, delta_onemC)) +
geom_point(aes(col = species)) +
geom_encircle(aes(fill = species), s_shape = 1, expand = 0, alpha = 0.2, show.legend = FALSE) +
facet_wrap(~species)
ggplot(long_dist_photo, aes(uni, delta_total_reflectance)) +
geom_point(aes(col = species)) +
geom_encircle(aes(fill = species), s_shape = 1, expand = 0, alpha = 0.2, show.legend = FALSE) +
facet_wrap(~species)
pair_wise_photo_Ek_FqFmmax <- FqFmparams %>%
ungroup() %>%
mutate(pair = str_sub(sampleID, start = 2)) %>%
select(pair, species, term, estimate, habitat) %>%
pivot_wider(names_from = term, values_from = estimate) %>%
pivot_wider(names_from = habitat, values_from = FqFmmax:Ek) %>%
mutate(pair = as.numeric(pair)) %>%
filter(pair != 96 & pair != 49)
long_dist_photo_Ek_FqFmmax <- left_join(long_dist, pair_wise_photo_Ek_FqFmmax, by = c("pair1" = "pair") ) %>%
mutate(delta_FqFmmax = FqFmmax_cryptic - FqFmmax_exposed,
delta_Ek = Ek_exposed - Ek_cryptic)
ggplot(long_dist_photo_Ek_FqFmmax, aes(uni, delta_Ek)) +
geom_point(aes(col = species)) +
geom_encircle(aes(fill = species), s_shape = 1, expand = 0, alpha = 0.2, show.legend = FALSE) +
facet_wrap(~species)
lm_Ek <- long_dist_photo_Ek_FqFmmax %>% group_by(species) %>% do(tidy(lm(uni ~ delta_Ek, data = .))) %>%
filter(term == "delta_Ek")
lm_FqFmmax <- long_dist_photo_Ek_FqFmmax %>% group_by(species) %>% do(tidy(lm(uni ~ delta_FqFmmax, data = .))) %>%
filter(term == "delta_FqFmmax")
lm_onemC <- long_dist_photo %>% group_by(species) %>% do(tidy(lm(uni ~ delta_onemC, data = .))) %>%
filter(term == "delta_onemC")
lm_onemQ <- long_dist_photo %>% group_by(species) %>% do(tidy(lm(uni ~ delta_onemQ, data = .))) %>%
filter(term == "delta_onemQ")
lm_total_reflectance <- long_dist_photo %>% group_by(species) %>% do(tidy(lm(uni ~ delta_total_reflectance, data = .))) %>%
filter(term == "delta_total_reflectance")
lm_onemC <- long_dist_photo %>% group_by(species) %>% do(tidy(lm(uni ~ delta_onemC, data = .)))
lm_onemC <- long_dist_photo %>% group_by(species)
View(lm_onemC)
